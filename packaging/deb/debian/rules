#!/usr/bin/make -f

export PYBUILD_NAME=docking
export PYBUILD_SYSTEM=pyproject

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_install:
	dh_install
	# Optional app icons (hicolor theme). If present in source tree,
	# copy into package so Icon=org.docking.Docking resolves from desktop environments.
	if [ -d packaging/deb/icons/hicolor ]; then \
		mkdir -p debian/docking/usr/share/icons/hicolor; \
		cp -a packaging/deb/icons/hicolor/. debian/docking/usr/share/icons/hicolor/; \
	fi

override_dh_auto_test:
	# Tests require pytest and dev deps; run in CI instead

override_dh_auto_install:
	dh_auto_install
	# Ensure /usr/bin/docking exists even on older setuptools/pybuild stacks
	# where project.scripts may not be emitted.
	mkdir -p debian/docking/usr/bin
	if [ ! -x debian/docking/usr/bin/docking ]; then \
		install -m 0755 packaging/deb/docking debian/docking/usr/bin/docking; \
	fi
	# Bundle ALL pip dependencies into an isolated vendor directory.
	# This avoids file conflicts with Ubuntu's python3-* system packages
	# and makes the .deb fully self-contained.
	# The docking entrypoint adds /usr/lib/docking/vendor to sys.path.
	python3 -m pip install --no-compile \
		--target=debian/docking/usr/lib/docking/vendor \
		openmeteo-requests requests-cache retry-requests
	# Remove .dist-info so dh_python3 won't auto-add vendored
	# packages as system dependencies.
	rm -rf debian/docking/usr/lib/docking/vendor/*.dist-info
	rm -rf debian/docking/usr/lib/docking/vendor/bin

override_dh_python3:
	# Keep runtime Python deps self-contained via vendored wheels under
	# /usr/lib/docking/vendor; avoid auto-deriving system python3-* deps
	# from upstream metadata (e.g. requests-cache for weather).
	dh_python3 --shebang=/usr/bin/python3 --no-guessing-deps
